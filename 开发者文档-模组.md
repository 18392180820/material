# F1模组接入云平台

## 1 硬件平台介绍

### 1.1 F1模组简介

- F1模组采用乐鑫[ESP8266芯片](https://www.espressif.com/zh-hans/products/hardware/esp8266ex/overview)，将ESP8266的应用电路作一个封装，使之成为一个相对独立的功能模块，对电控板等设备展现一个统一的接口和通信控制协议。 
- F1模组内部集成RF收成电路、基带电路、WiFi协议栈、SRAM、通用CPU、各种外设等功能，模块固件存放在板载Flash中，与主芯片通过SPI接口连接。
- F1模块采用COB设计，本身包含Chip，Flash，LDO组成完整的WiFi的功能节点，并支持片上软件的二次开发，可作为独立控制器单独使用，也可作为其他控制板的外设来提供WiFi接入的功能。

<img src="https://raw.githubusercontent.com/18392180820/material/master/F1%E6%A8%A1%E5%9D%97%E7%94%B5%E6%B0%94%E6%A1%86%E5%9B%BE.png" width="85%" height="35%">
	
### 1.2 F1模组性能指标

<table>
    <tr>
        <th>类别</th>
        <th>性能指标名称</th>
        <th>性能指标要求</th>  
    </tr >
    <tr >
        <td rowspan="2">模块</td>
        <td>型号</td>
        <td>FT_SIGW_F1_P</td>
    </tr>
    <tr>
        <td>主芯片</td>
        <td>ESP8266</td>
    </tr>
    <tr >
        <td rowspan="12">无线参数</td>
        <td>无线标准</td>
        <td>IEEE 802.11b/g/n</td>
    </tr>
    <tr>
        <td>频率范围</td>
        <td>2.4 GHz ~ 2.5 GHz (2400MHz ~ 2483.5MHz)</td>
    </tr>
    <tr >
        <td rowspan="2">发射功率</td>
        <td>72.2Mbps下，PA的输出功率 13dBm（min）\14dBm (type)\15dBm (max)</td>
    </tr>
    <tr>
        <td>11b模式下，PA的输出功率 19.5dBm（min）\20dBm (type)\20.5dBm (max)</td>
    </tr>
    <tr >
        <td rowspan="5">接收灵敏度</td>
        <td>DSSS,1Mbps -98dBm(type)</td>
    </tr>
    <tr>
        <td>CCK,11Mbps -91dBm(type)</td>
    </tr>
    <tr>
        <td>6Mbps(1/2 BPSK) -93dBm(type)</td>
    </tr>
    <tr>
        <td>54Mbps(3/4 64-QAM) -75dBm(type)</td>
    </tr>
    <tr>
        <td>HT20,MCS7(65Mbps, 72.2Mbps) -72dBm(type)</td>
    </tr>
    <tr>
        <td>天线形式</td>
        <td>内置：板载PCB 天线</td>
    </tr>
    <tr>
        <td>配网成功率</td>
        <td>RSSI≥-65dBm时高于95%</td>
    </tr>
    <tr>
        <td>扫描周围热点信号的能力</td>
        <td>能够搜索到RSSI≥-80dBm的信号</td>
    </tr>
    <tr >
        <td rowspan="7">硬件参数</td>
        <td>硬件接口</td>
        <td>UART</td>
    </tr>
    <tr>
        <td>工作电压</td>
        <td>5V±10%</td>
    </tr>
    <tr>
        <td>GPIO驱动能力</td>
        <td>Max：15ma</td>
    </tr>
    <tr>
        <td>工作电流</td>
        <td>平均值：~80mA@5V,峰值: <500mA@5V </td>
    </tr>
    <tr>
        <td>工作温度</td>
        <td>-40℃~85℃</td>
    </tr>
    <tr>
        <td>存储环境</td>
        <td>温度：-40℃~85℃，相对湿度：<90%R.H.</td>
    </tr>
    <tr>
        <td>尺寸</td>
        <td>(50.0±0.2)mm x (25.0±0.2)mm x (4.8±0.15)mm</td>
    </tr>
    <tr>
        <td>串口透传</td>
        <td>传输速率</td>
        <td>9600-115200bps</td>
    </tr>
</table>

更多硬件参考内容、请查阅[Fotile\_F1模组电气硬件使用说明]()。

## 2 模组SDK介绍

F1模组开发SDK分两部分：

- **乐鑫ESP8266\_RTOS\_SDK\_release/V3.2**
- **方太Fotile\_SDK**

### 2.1 ESP8266\_RTOS\_SDK\_release/V3.2介绍

乐鑫SDK可以在[git](https://github.com/espressif/ESP8266_RTOS_SDK)上下载，下载后需要通过<font color=red>`git branch`</font>命令切换到release版本。

乐鑫SDK中提供了适用于8266芯片开发的API，详情请查看[乐鑫官网](https://www.espressif.com/zh-hans/products/hardware/esp8266ex/overview)、或是[SDK使用指南](https://www.espressif.com/zh-hans/support/download/documents/chips)。

### 2.2 Fotile\_SDK介绍

Fotile_SDK在乐鑫SDK基础上开发了适用于方太产品的二次集成，主要包括以下几点：

- UART功能的集成
	
	除与设备的串口通信外，用户可以向串口发送既定的[命令格式]()，实现模组快速配网、模拟设备调试、查询freertos运行状态等功能。
- WiFi功能的集成：

	用户可根据Fotile\_SDK中的API，快速实现Soft\_AP等功能、让模组智能联网。
- MQTT功能的集成：

	方太MQTT在ESP\_MQTT的基础上，对MQTT客户端的鉴权登录、主题订阅、主题发布做了二次包装，方便用户使用。
- OTA功能的集成：

	用户在[方太云OTA管理台]()上传升级包后，调用API可以实现模组的在线升级。同时对电控板可在线升级的设备、也提供了电控版的在线升级接口。
- 智能菜谱的集成：

	对支持智能菜谱的设备，用户可通过调用API实现智能菜谱的录制、播放、上传等功能，实现菜谱的共享。
- 语音盒子的集成：

	对支持语音盒子的设备，提供了语音的开发接口。

更多SDK参考内容、请查阅[Fotile\_SDK开发手册]()。

## 3 设备接入及调试流程

### 3.1 设备接入云平台

设备接入云平台前的前提是：

- **产品已在[云平台导入物模板](http://47.96.36.164:40000/)**
- **设备mac已录入云平台**

设备接入云平台的流程图如下：

<img src="https://raw.githubusercontent.com/18392180820/material/master/%E8%AE%BE%E5%A4%87%E6%8E%A5%E5%85%A5%E4%BA%91%E5%B9%B3%E5%8F%B0%E6%B5%81%E7%A8%8B.png" width="70%" height="40%">

- 设备端发起配网流程
- 终端向设备发送配网信息，例如热点SSID、PWD
- 设备连接热点、连网
- 设备鉴权、接入云平台
- 设备通过设备型号获取云端物模型
- 设备加载物模型并上报设备状态给云端

### 3.2 设备控制与状态同步

设备接入云平台流程结束后，终端与设备处于绑定状态，终端、云平台、设备之间的通讯渠道为**MQTT**，下图为终端控制设备、设备状态上报的简单流程：

<img src="https://raw.githubusercontent.com/18392180820/material/master/%E8%AE%BE%E5%A4%87%E3%80%81%E4%BA%91%E3%80%81%E7%BB%88%E7%AB%AF%E7%AE%80%E5%8D%95%E4%BA%A4%E4%BA%92.png" width="70%" height="40%">

对以上流程做简要说明：

- 设备控制以及状态上报内容格式为JSON，JSON关键字由物模型提取
- 使用Fotile\_SDK的产品、MQTT心跳时间从云端获取
- 使用Fotile\_SDK的产品、设备只在状态上报时、或移动终端主动查询时上报设备状态


